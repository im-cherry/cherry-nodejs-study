# 08 데이터 베이스 사용하기

## 1. MySQL 설치하기

[MySQL 공식 사이트](https://www.mysql.com/downloads) 에서 다운로드 하여 설치합니다. (MySQL Community Server)

<br/>
<br/>

## 2. 데이터베이스 및 테이블 생성하기

- 데이터베이스 생성 : 상단 메뉴의 스키마 생성 버튼 선택

  - Schema Name : dev
  - Character Set : utf8
  - Collation: utf8_general_ci

- 테이블 생성 : 데이터 베이스(dev)의 Tables 에서 마우스 오른쪽 클릭 > Create Table 클릭

  - Name : customers

    | Column  | Datatype     | options    |
    | :------ | :----------- | :--------- |
    | id      | INT          | PK, NN, AI |
    | name    | VARCHAR(45)  | NN         |
    | email   | VARCHAR(45)  | NN         |
    | phone   | VARCHAR(45)  | NN         |
    | address | VARCHAR(100) |            |

- 데이터 추가

  ```mysql
  insert into dev.customers(id, name, email, phone, address) values(1, 'John Doe', 'john@mail.com', '010-0000-0000', 'Daejeon')
  ```

<br/>
<br/>

## 3. MySQL 모듈 사용하기

### 1) mysql 모듈을 MySQL 을 조작하기 위해서 가장 많이 사용되고 있는 모듈입니다.

```
npm install mysql
```

<br/>

### 2) MySQL 연결

- 터미널에서 `mysql -h localhost -u root -p` 입력 후, mysql 접속

- Nodejs 사용을 위한 계정 생성

  ```
  > CREATE USER 'dev01'@'%' IDENTIFIED WITH MYSQL_NATIVE_PASSWORD BY '1234';
  > GRANT ALL PRIVILEGES ON dev.* to 'dev01'@'%' WITH GRANT OPTION;
  > flush privileges;
  ```

- /node-project/blob/main/mysql/sql.js 파일 생성

  ```javascript
  module.exports = {
    customerList: "select * from customers", // 데이터 조회
    customerInsert: "insert into customers set ?", // 데이터 추가
    customerUpdate: "update customers set ? where id=?", // 데이터 수정
    customerDelete: "delete from customers where id=?", // 데이터 삭제
  };
  ```

- node-project/blob/main/mysql/index.js 파일 생성

  ```javascript
  const mysql = require("mysql");
  const sql = require("./sql.js");

  const pool = mysql.createPool({
    connectionLimit: 10,
    host: "127.0.0.1",
    port: 3306,
    user: "dev01",
    password: "1234",
    database: "dev",
  });

  const query = async (alias, values) => {
    return await pool.query(sql[alias], values, (error, results) => {
      if (error) {
        console.log(error);
        throw error;
      } else {
        console.log(results);
      }
    });
  };

  module.exports = {
    query,
  };
  ```

- node-project/blob/main/app_mysql.js

  ```javascript
  const express = require("express");
  const mysql = require("./mysql");

  const app = express();

  app.listen(3000, () => {
    console.log("3000번 포트로 웹 서버 실행");
  });

  // 정보 조회
  app.get("/api/customers", async (req, res) => {
    const customers = await mysql.query(customerList);
    console.log(customers);
    res.send(customers);
  });

  // 정보 추가
  app.post("/api/customer/insert", async (req, res) => {
    console.log(req.body);

    const result = await mysql.query("customerInsert", req.body.param);
    res.send(result);
  });

  // 정보 수정
  app.put("/api/customer/update", async (req, res) => {
    console.log(req.body);

    const result = await mysql.query("customerUpdate", req.body.param);
    res.send(result);
  });

  // 정보 삭제
  app.delete("/api/customer/delete/:id", async (req, res) => {
    const { id } = req.params;
    const result = await mysql.query("customerDelete", id);
    res.send(result);
  });
  ```

<br/>

### 3) dotenv 모듈 사용

dotenv 모듈은 접속 정보처럼 보안상 중요한 데이터를 .env 파일로 저장하고 Nodejs 가 실행될때 .env 파일에 저장되어 있는 데이터를 환경 변수에 등록시켜서 사용할 수 있게 해줍니다.

```
npm install dotenv
```

- mysql/.env

  ```env
  MYSQL_HOST=localhost
  MYSQL_PORT=3306
  MYSQL_USERNAME=dev01
  MYSQL_PASSWORD=1234
  MYSQL_DB=dev
  MYSQL_LIMIT=10
  ```

- node-project/blob/main/mysql/index.js

  ```javascript
  const pool = mysql.createPool({
    connectionLimit: process.env.MYSQL_LIMIT,
    host: process.env.MYSQL_HOST,
    port: process.env.MYSQL_PORT,
    user: process.env.MYSQL_USERNAME
    password: process.env.MYSQL_PASSWORD,
    database: process.env.MYSQL_DB,
  })

  const query = async (alias, values) => {
    return await pool.query(sql[alias], values, (error, results) => {
      if (error) {
        console.log(error);
        throw error;
      } else {
        console.log(results);
      }
    });
  };

  module.exports = {
    query,
  };
  ```

- node-project/blob/main/app_mysql.js

  ```javascript
  const express = require("express");
  require("dotenv").config({ path: "mysql/.env" });

  const mysql = require("./mysql");
  const app = express();

  app.listen(3000, () => [console.log("3000번 포트로 웹서버 실행")]);
  ```

<br/>

### 4) nodemon 모듈 설치

`nodemon` 은 node monitor의 약자로, 특정 디렉터리 혹은 파일을 감시하고 있다가 변경사항이 발행사면 Node.js 애플리케이션을 재시작하는 모듈입니다.

```
$ npm install --save-dev nodemon
$ nodemon app.js

$ nodemon --watch [감시 대상] [재실행 파일]
$ nodemon --watch mysql app.js
```

<br/>
<br/>

:arrow_forward:[09 애플리케이션 운영과 고성능 웹을 위한 Nodejs](./09%20%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98%20%EC%9A%B4%EC%98%81%EA%B3%BC%20%EA%B3%A0%EC%84%B1%EB%8A%A5%20%EC%9B%B9%EC%9D%84%20%EC%9C%84%ED%95%9C%20Nodejs.md):arrow_forward:
